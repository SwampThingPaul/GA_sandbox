name: Render R Markdown (Windows) - test

on:
  push:
    branches: [master]
  workflow_dispatch:
  schedule:
    - cron: '15,30,45 * * * *'
    
jobs:
  render:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        
      - name: Install RTools (required for compilation)
        run: |
          choco install rtools --version=4.0.0.20230203

      - name: Add RTools to PATH
        run: |
          echo "C:\\rtools40\\usr\\bin" >> $GITHUB_PATH
          echo "C:\\rtools40\\mingw64\\bin" >> $GITHUB_PATH

      - name: Set up R package cache
        uses: r-lib/actions/setup-renv@v2
        
      - name: Restore renv packages (set download method to libcurl)
        run: |
          Rscript -e "Sys.setenv(RENV_DOWNLOAD_METHOD = 'libcurl'); renv::restore()"

      - name: Restore R packages with renv
        shell: Rscript {0}
        run: |
          renv::restore()

      - name: Render R Markdown
        shell: Rscript {0}
        run: |
          rmarkdown::render("test_report.Rmd")

      - name: Commit rendered report
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add test_report.html
          git commit -m "Rendered report" || echo "Nothing to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


# 
# jobs:
#   render:
#     name: Render report
#     runs-on: windows-latest
#     env:
#       GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
# 
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
# 
#       - name: Set up R
#         uses: r-lib/actions/setup-r@v2
#         
#       - uses: r-lib/actions/setup-pandoc@v2
# 
#       - name: Install renv and restore packages
#         run: |
#           Rscript -e "install.packages('renv', repos = 'https://cloud.r-project.org')"
#           Rscript -e "renv::restore()"
# 
#       - name: Render R Markdown
#         run: |
#           Rscript -e "rmarkdown::render('test_report.Rmd')"
# 
#       - name: Upload rendered report
#         uses: actions/upload-artifact@v4
#         with:
#           name: rendered-report
#           path: test_report.html
